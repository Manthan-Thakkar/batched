name: Batched LabelTraxx Tenant DB Deploy - v2

on:
  workflow_dispatch:
    inputs:
      deploy_to_environment:
        type: choice
        description: choose on which environment want to deploy
        options:
        - Development
        - Production

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout

jobs:
  initial:
    name: Initial Setup LabelTraxx Deployment
    environment: ${{ github.event.inputs.deploy_to_environment }}
    runs-on: "${{ github.event.inputs.deploy_to_environment == 'Development' && 'batched-dev-runner' || github.event.inputs.deploy_to_environment == 'Production' && 'batched-prod-runner' || 'default-runner' }}"
    defaults:
      run:
        working-directory: ./BatchedDB.Tenant.LabelTraxx/StateBasedBuild
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: actions/setup-dotnet@v5
      env:
        DOTNET_INSTALL_DIR: ${{ github.workspace }}/.dotnet
      with:
        dotnet-version: '8'
    
    - name: Build Model tenant DB LabelTraxx
      run: dotnet build

    - name: Build & Deploy Model tenant DB LabelTraxx
      run: |
          export PATH="$HOME/.dotnet/tools:$PATH"
          sqlpackage /Action:Publish \
          /SourceFile:./bin/Debug/netstandard2.0/model-Tenant.dacpac \
          /TargetServerName:${{ secrets.DB_TSN }},1433 \
          /TargetDatabaseName:model-tenantdb-labeltraxx \
          /TargetUser:${{ secrets.DB_USERNAME }} \
          /TargetPassword:'${{ secrets.DB_PASSWORD }}' \
          /DeployScriptPath:"./Result-${{ github.run_number }}.txt" \
          /p:TreatVerificationErrorsAsWarnings=True \
          /p:BlockOnPossibleDataLoss=True

  setup:
    needs: initial
    name: Setup Multi Tenant Scripts
    environment: ${{ github.event.inputs.deploy_to_environment }}
    runs-on: "${{ github.event.inputs.deploy_to_environment == 'Development' && 'batched-dev-runner' || github.event.inputs.deploy_to_environment == 'Production' && 'batched-prod-runner' || 'default-runner' }}"
    outputs:
      db-matrix: ${{ steps.set-matrix.outputs.db-matrix }}
    defaults:
      run:
        working-directory: ./BatchedDB.Tenant.LabelTraxx/MigrationBasedBuild
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - uses: actions/setup-dotnet@v5
      env:
        DOTNET_INSTALL_DIR: ${{ github.workspace }}/.dotnet
      with:
        dotnet-version: '8'
    
    - name: Build LabelTraxx tenant's Base DB
      run: dotnet build
    
    - name: Get DB List
      run: sqlcmd -S ${{ secrets.DB_TSN }},1433 -U ${{ secrets.DB_USERNAME }} -P '${{ secrets.DB_PASSWORD }}' -W -h -1 -q "Set NoCount ON; Use batched; Select DBname from Batched.dbo.TenantDatabase where DBname in (SELECT name FROM sys.databases)" -m 1 -C -o dblist

    - name: Generate Matrix
      id: set-matrix
      run: |
          dblist_out=$(grep -v '^\s*$' dblist | jq -R -s -c 'split("\n")[:-1]')
          echo "Generated matrix: $dblist_out"
          echo "db-matrix=$dblist_out" >> $GITHUB_OUTPUT

    - name: Generate Deployment Script
      run: |
        echo "Generating script against representative tenant DB..."
        export PATH="$HOME/.dotnet/tools:$PATH"
        sqlpackage /Action:Script \
        /SourceFile:./bin/Debug/netstandard2.0/model-Tenant.dacpac \
        /TargetServerName:${{ secrets.DB_TSN }},1433 \
        /TargetDatabaseName:batched-demo-demo-tenant \
        /TargetUser:${{ secrets.DB_USERNAME }} \
        /TargetPassword:'${{ secrets.DB_PASSWORD }}' \
        /OutputPath:"./deploy-script.sql" \
        /p:BlockOnPossibleDataLoss=True
        sed -i '/^:setvar DatabaseName /d' ./deploy-script.sql

    - name: Upload SQL Script Artifact
      uses: actions/upload-artifact@v4
      with:
        name: lt-sql-script
        path: ./BatchedDB.Tenant.LabelTraxx/MigrationBasedBuild/deploy-script.sql
        retention-days: 1

    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Multi-Tenant Migration - LabelTraxx - Environment: **${{ github.event.inputs.deploy_to_environment }}**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** Batched LabelTraxx Tenant DB Deploy - v2" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered By:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  run-migration:
    needs: setup
    name: "Migration for ${{ matrix.value }}"
    environment: ${{ github.event.inputs.deploy_to_environment }}
    runs-on: "${{ github.event.inputs.deploy_to_environment == 'Development' && 'batched-dev-runner' || github.event.inputs.deploy_to_environment == 'Production' && 'batched-prod-runner' || 'default-runner' }}"
    strategy:
      fail-fast: false
      matrix:
        value: ${{ fromJSON(needs.setup.outputs.db-matrix) }}
      max-parallel: 6
    
    steps:
      - name: Download SQL Script artifact
        uses: actions/download-artifact@v4
        with:
          name: lt-sql-script
          path: .

      - name: Execute Migration Script on ${{ matrix.value }}
        run: |
          echo "Executing script on database: ${{ matrix.value }}"
          sqlcmd -S ${{ secrets.DB_TSN }},1433 \
          -U ${{ secrets.DB_USERNAME }} \
          -P '${{ secrets.DB_PASSWORD }}' \
          -v DatabaseName="${{ matrix.value }}" \
          -i ./deploy-script.sql -C
