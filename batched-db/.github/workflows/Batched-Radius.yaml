name: Batched Radius DB Deploy

on:
  workflow_dispatch:
    inputs:
      deploy_to_environment:
        type: choice
        description: choose on which environment want to deploy
        options:
        - Development
        - Production

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout

jobs:
  initial:
    name: Initial Setup Radius Deployment
    environment: ${{ github.event.inputs.deploy_to_environment }}
    runs-on: "${{ github.event.inputs.deploy_to_environment == 'Development' && 'batched-dev-runner' || github.event.inputs.deploy_to_environment == 'Production' && 'batched-prod-runner' || 'default-runner' }}"
    defaults:
      run:
        working-directory: ./BatchedDB.Tenant.Radius/StateBasedBuild
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: actions/setup-dotnet@v5
      env:
        DOTNET_INSTALL_DIR: ${{ github.workspace }}/.dotnet
      with:
        dotnet-version: '8'
    
    - name: Build Model tenant DB Radius
      run: dotnet build

    - name: Build & Deploy Model tenant DB Radius
      run: |
          export PATH="$HOME/.dotnet/tools:$PATH"
          sqlpackage /Action:Publish \
          /SourceFile:./bin/Debug/netstandard2.0/model-Tenant.dacpac \
          /TargetServerName:${{ secrets.DB_TSN }},1433 \
          /TargetDatabaseName:model-tenantdb-radius \
          /TargetUser:${{ secrets.DB_USERNAME }} \
          /TargetPassword:'${{ secrets.DB_PASSWORD }}' \
          /DeployScriptPath:"./Result-${{ github.run_number }}.txt" \
          /p:TreatVerificationErrorsAsWarnings=True \
          /p:BlockOnPossibleDataLoss=True

  setup:
    needs: initial
    name: Setup Multi Tenant Scripts
    environment: ${{ github.event.inputs.deploy_to_environment }}
    runs-on: "${{ github.event.inputs.deploy_to_environment == 'Development' && 'batched-dev-runner' || github.event.inputs.deploy_to_environment == 'Production' && 'batched-prod-runner' || 'default-runner' }}"
    outputs:
      db-matrix: ${{ steps.set-matrix.outputs.db-matrix }}
    defaults:
      run:
        working-directory: ./BatchedDB.Tenant.Radius/MigrationBasedBuild
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - uses: actions/setup-dotnet@v5
      env:
        DOTNET_INSTALL_DIR: ${{ github.workspace }}/.dotnet
      with:
        dotnet-version: '8'
    
    - name: Build Radius tenant's Base DB
      run: dotnet build
    
    - name: Get DB List
      run: sqlcmd -S ${{ secrets.DB_TSN }},1433 -U ${{ secrets.DB_USERNAME }} -P '${{ secrets.DB_PASSWORD }}' -W -h -1 -q "Set NoCount ON; Use batched; Select DBname from Batched.dbo.TenantDatabase TD INNER JOIN Tenant T ON TD.TenantId = T.ID INNER JOIN ERPMaster EM ON T.ERPId = EM.Id where T.IsEnabled = 1 AND EM.Name = 'Radius'" -m 1 -C -o dblist

    - name: Generate Matrix
      id: set-matrix
      run: |
          dblist_out=$(grep -v '^\s*$' dblist | jq -R -s -c 'split("\n")[:-1]')
          echo "Generated matrix: $dblist_out"
          echo "db-matrix=$dblist_out" >> $GITHUB_OUTPUT

    - name: Upload file artifact
      uses: actions/upload-artifact@v4
      with:
        name: radius-dacpac-file
        path: ./BatchedDB.Tenant.Radius/MigrationBasedBuild/bin/Debug/netstandard2.0/model-Tenant.dacpac

    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Multi-Tenant Migration - Radius - Environment: **${{ github.event.inputs.deploy_to_environment }}**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** Batched Radius DB Deploy" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered By:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  run-migration:
    needs: setup
    name: "Migration for ${{ matrix.value }}"
    environment: ${{ github.event.inputs.deploy_to_environment }}
    runs-on: "${{ github.event.inputs.deploy_to_environment == 'Development' && 'batched-dev-runner' || github.event.inputs.deploy_to_environment == 'Production' && 'batched-prod-runner' || 'default-runner' }}"
    strategy:
      fail-fast: false
      matrix: 
        value: ${{ fromJSON(needs.setup.outputs.db-matrix) }}
      max-parallel: 6
    
    steps:
      - name: Download file artifact
        uses: actions/download-artifact@v4
        with:
          name: radius-dacpac-file
          path: .
      - name: Migrate database ${{ matrix.value }}
        run: |
          echo "Migrating database: ${{ matrix.value }}"
          export PATH="$HOME/.dotnet/tools:$PATH"
          sqlpackage /Action:Publish \
          /SourceFile:./model-Tenant.dacpac \
          /TargetServerName:${{ secrets.RADIUS_DB_TSN }},1433 \
          /TargetDatabaseName:${{ matrix.value }} \
          /TargetUser:${{ secrets.RADIUS_DB_USERNAME }} \
          /TargetPassword:'${{ secrets.RADIUS_DB_PASSWORD }}' \
          /DeployScriptPath:"./Result-${{ github.run_number }}.txt" \
          /p:TreatVerificationErrorsAsWarnings=True \
          /p:BlockOnPossibleDataLoss=True